# Active Context

## Latest Session (Jan 19, 2026) - ‚úÖ –§–ò–ù–ê–ù–°–û–í–´–ô –û–¢–ß–ï–¢ –ö–ê–ö –ù–ê WB:

**üéØ CURRENT FOCUS**: –ü–æ–ª–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ –æ—Ç—á–µ—Ç–∞ –∫–∞–∫ –Ω–∞ —Å–∞–π—Ç–µ WB - 71 –∫–æ–ª–æ–Ω–∫–∞ —Å –ø–µ—Ä–µ–Ω–æ—Å–æ–º —Å–ª–æ–≤ –∏ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ–º

### –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ:

**1. FULL FINANCIAL REPORT STRUCTURE - 71 –∫–æ–ª–æ–Ω–∫–∞ –∫–∞–∫ –Ω–∞ WB!**:
- **–ü—Ä–æ–±–ª–µ–º–∞**: –¢–∞–±–ª–∏—Ü–∞ –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞–ª–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ WB - –±—ã–ª–æ 38 –∫–æ–ª–æ–Ω–æ–∫, –Ω—É–∂–Ω–æ 71
- **–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ**: 
  - –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —Å–∫—Ä–∏–Ω—à–æ—Ç—ã —Å —Å–∞–π—Ç–∞ WB Partners
  - –ò–∑—É—á–µ–Ω–∞ Google —Ç–∞–±–ª–∏—Ü–∞ (Excel —ç–∫—Å–ø–æ—Ä—Ç) - 85 –∫–æ–ª–æ–Ω–æ–∫
  - **–†–µ—à–µ–Ω–∏–µ**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –°–ê–ô–¢–ê WB (71 –∫–æ–ª–æ–Ω–∫–∞), –Ω–µ Excel (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø—Ä–∏–≤—ã–∫–ª–∏ –∫ —Å–∞–π—Ç—É)
- **–†–µ–∞–ª–∏–∑–∞—Ü–∏—è**:
  - –ü–µ—Ä–µ–¥–µ–ª–∞–Ω—ã –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã (~71 <th> —Ç–µ–≥)
  - –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `renderFinReportData()` - —Ç–µ–ø–µ—Ä—å –≤—ã–≤–æ–¥–∏—Ç –≤—Å–µ 71 –∫–æ–ª–æ–Ω–∫—É
  - Colspan –∏–∑–º–µ–Ω—ë–Ω —Å 38 –Ω–∞ 71
- **–ö–æ–ª–æ–Ω–∫–∏ –≤–∫–ª—é—á–∞—é—Ç**: ‚Ññ, –ù–æ–º–µ—Ä –ø–æ—Å—Ç–∞–≤–∫–∏, –ü—Ä–µ–¥–º–µ—Ç, –ö–æ–¥ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã, –ë—Ä–µ–Ω–¥, –ê—Ä—Ç–∏–∫—É–ª, –ù–∞–∑–≤–∞–Ω–∏–µ, –†–∞–∑–º–µ—Ä, –ë–∞—Ä–∫–æ–¥, –¢–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞, –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ–ø–ª–∞—Ç—ã, –î–∞—Ç—ã, –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ, –¶–µ–Ω—ã, –°–∫–∏–¥–∫–∏ (–°–ü–ü, –ø—Ä–æ–º–æ–∫–æ–¥, –∏—Ç–æ–≥–æ–≤–∞—è), –∫–í–í (—Ä–∞–∑–º–µ—Ä—ã, –ø—Ä–æ—Ü–µ–Ω—Ç—ã), –í–æ–∑–º–µ—â–µ–Ω–∏—è, –≠–∫–≤–∞–π—Ä–∏–Ω–≥, –ù–î–°, –ö –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—é, –õ–æ–≥–∏—Å—Ç–∏–∫–∞, –®—Ç—Ä–∞—Ñ—ã, –•—Ä–∞–Ω–µ–Ω–∏–µ, –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ (–®–ö, Srid, –ö–ò–ó, –∫–æ—Ä–æ–±–∞, –ø–∞—Ä—Ç–Ω–µ—Ä—ã, —Å–∫–ª–∞–¥—ã)
- **–ö–æ–¥ –∏–∑–º–µ–Ω—ë–Ω**: 
  - index.js lines 1451-1530 - –ø–æ–ª–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
  - index.js lines 3291-3368 - —Ñ—É–Ω–∫—Ü–∏—è renderFinReportData() —Å 71 –∫–æ–ª–æ–Ω–∫–æ–π
- **–†–µ–∑—É–ª—å—Ç–∞—Ç**: ‚úÖ **–¢–æ—á–Ω–∞—è –∫–æ–ø–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã WB —Å–∞–π—Ç–∞**

**2. WORD WRAP IN HEADERS - –ü–µ—Ä–µ–Ω–æ—Å —Å–ª–æ–≤ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö**:
- **–ü—Ä–æ–±–ª–µ–º–∞**: –ö–æ–ª–æ–Ω–∫–∏ –±—ã–ª–∏ —Å–ª–∏—à–∫–æ–º —à–∏—Ä–æ–∫–∏–µ –∏–∑-–∑–∞ `white-space:nowrap`
- **–†–µ—à–µ–Ω–∏–µ**: 
  - –£–±—Ä–∞–Ω `white-space:nowrap` –∏–∑ –≤—Å–µ—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
  - –î–æ–±–∞–≤–ª–µ–Ω `word-wrap:break-word`
  - –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã `min-width` –∏ `max-width` –¥–ª—è –∫–∞–∂–¥–æ–π –∫–æ–ª–æ–Ω–∫–∏ (–æ—Ç 40px –¥–æ 190px)
- **–ö–æ–¥ –∏–∑–º–µ–Ω—ë–Ω**:
  - index.js lines 1451-1530 - –≤—Å–µ 71 –∑–∞–≥–æ–ª–æ–≤–æ–∫ –æ–±–Ω–æ–≤–ª–µ–Ω—ã
- **–†–µ–∑—É–ª—å—Ç–∞—Ç**: ‚úÖ –ö–æ–º–ø–∞–∫—Ç–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏ —Å –ø–µ—Ä–µ–Ω–æ—Å–æ–º —Ç–µ–∫—Å—Ç–∞ –∫–∞–∫ –Ω–∞ WB

**3. TEXT ALIGNMENT - –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤**:
- **–ó–∞–¥–∞—á–∞**: –í—Å–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤—ã—Ä–æ–≤–Ω–µ–Ω—ã –ø–æ –ª–µ–≤–æ–º—É –∫—Ä–∞—é
- **–†–µ—à–µ–Ω–∏–µ**: 
  - –ú–∞—Å—Å–æ–≤–∞—è –∑–∞–º–µ–Ω–∞ `text-align:right` –∏ `text-align:center` –Ω–∞ `text-align:left`
  - –ü—Ä–∏–º–µ–Ω–µ–Ω–æ –∫–æ –í–°–ï–ú –∑–∞–≥–æ–ª–æ–≤–∫–∞–º —Ç–∞–±–ª–∏—Ü (—Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –æ—Ç—á–µ—Ç, –ø—Ä–æ–¥–∞–∂–∏, –∑–∞–∫–∞–∑—ã)
- **–ö–æ–º–∞–Ω–¥–∞**: PowerShell regex replace –Ω–∞ –≤–µ—Å—å index.js
- **–†–µ–∑—É–ª—å—Ç–∞—Ç**: ‚úÖ –í—Å–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –≤—ã—Ä–æ–≤–Ω–µ–Ω—ã —Å–ª–µ–≤–∞

**PREVIOUS SESSION - FULL HISTORY SYNC + DATE FILTERS**:

**4. FULL HISTORY SYNC - –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞ –≤—Å—ë –≤—Ä–µ–º—è!**:
- **–ü—Ä–æ–±–ª–µ–º–∞**: –°–∏—Å—Ç–µ–º–∞ –∑–∞–≥—Ä—É–∂–∞–ª–∞ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 90 –¥–Ω–µ–π, —Ö–æ—Ç—è WB API –º–æ–∂–µ—Ç –æ—Ç–¥–∞—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é
- **–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ**: 
  - `/api/v1/supplier/sales` –∏ `/orders` - –ª–∏–º–∏—Ç 90 –¥–Ω–µ–π
  - `/api/v5/supplier/reportDetailByPeriod` - **–ë–ï–ó –ª–∏–º–∏—Ç–æ–≤!** –ú–æ–∂–Ω–æ –∑–∞–ø—Ä–æ—Å–∏—Ç—å –∑–∞ –≤—Å—ë –≤—Ä–µ–º—è!
- **–†–µ—à–µ–Ω–∏–µ**:
  - –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `getFullDateRange()` - –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Å 2019 –≥–æ–¥–∞ (–Ω–∞—á–∞–ª–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ WB)
  - –ò–∑–º–µ–Ω—ë–Ω `syncFinancialReport()` - —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `getFullDateRange()` –≤–º–µ—Å—Ç–æ `getMaxDateRange()`
  - Sales –∏ Orders –æ—Å—Ç–∞–ª–∏—Å—å —Å –ª–∏–º–∏—Ç–æ–º 90 –¥–Ω–µ–π (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ WB API)
- **–ö–æ–¥ –∏–∑–º–µ–Ω—ë–Ω**: 
  - sync-service.js ~line 57 - –¥–æ–±–∞–≤–ª–µ–Ω–∞ `getFullDateRange()`
  - sync-service.js ~line 252 - `syncFinancialReport()` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–æ–ª–Ω—ã–π –ø–µ—Ä–∏–æ–¥
- **–†–µ–∑—É–ª—å—Ç–∞—Ç**: ‚úÖ **–ó–∞–≥—Ä—É–∂–µ–Ω–æ 4041 –∑–∞–ø–∏—Å—å –¥–ª—è –º–∞–≥–∞–∑–∏–Ω–∞ 1 –∏ 5338 –¥–ª—è –º–∞–≥–∞–∑–∏–Ω–∞ 2 - –í–°–Ø –∏—Å—Ç–æ—Ä–∏—è!**

**5. TIMEZONE FIX - –í—Ä–µ–º—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ø–æ –ë–∏—à–∫–µ–∫—É**:
- **–ü—Ä–æ–±–ª–µ–º–∞**: Cron –±—ã–ª –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ 3:30 –ú–°–ö, –Ω—É–∂–Ω–æ –±—ã–ª–æ 3:30 –ø–æ –ë–∏—à–∫–µ–∫—É (= 00:30 –ú–°–ö)
- **–†–µ—à–µ–Ω–∏–µ**: 
  - –ò–∑–º–µ–Ω—ë–Ω cron —Å `'30 3 * * *'` –Ω–∞ `'30 0 * * *'`
  - –û–±–Ω–æ–≤–ª–µ–Ω—ã –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è: "3:30 —É—Ç—Ä–∞ (–ë–∏—à–∫–µ–∫)"
- **–ö–æ–¥ –∏–∑–º–µ–Ω—ë–Ω**:
  - index.js ~line 3604 - –∏–∑–º–µ–Ω–µ–Ω–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ cron
  - index.js ~line 3617 - –æ–±–Ω–æ–≤–ª–µ–Ω–æ –∫–æ–Ω—Å–æ–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
  - index.js ~line 3712 - –æ–±–Ω–æ–≤–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Å–ª–µ–¥—É—é—â–µ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- **–†–µ–∑—É–ª—å—Ç–∞—Ç**: ‚úÖ –ê–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ç–µ–ø–µ—Ä—å –≤ 3:30 —É—Ç—Ä–∞ –ø–æ –ë–∏—à–∫–µ–∫—É (00:30 –ú–°–ö)

**6. DATE FILTER AUTO-RELOAD**:
- –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ "–ü—Ä–∏–º–µ–Ω–∏—Ç—å" –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –¥–∞–Ω–Ω—ã–µ
- `applyDateRange()` ~line 2585 - –¥–æ–±–∞–≤–ª–µ–Ω –≤—ã–∑–æ–≤ `loadFinancialData()`

**7. LOCALSTORAGE FOR DATE RANGE**:
- –ü–µ—Ä–∏–æ–¥ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ localStorage –ø—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏
- –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥
- `applyDateRange()` ~line 2586-2587 - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ localStorage
- `DOMContentLoaded` ~line 2612-2628 - –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ localStorage

**8. QUICK RANGE BUTTONS FIX**:
- –ö–Ω–æ–ø–∫–∏ –ù–µ–¥–µ–ª—è/–ú–µ—Å—è—Ü/–ö–≤–∞—Ä—Ç–∞–ª/–ì–æ–¥ —Ç–µ–ø–µ—Ä—å —Å—Ä–∞–∑—É –ø—Ä–∏–º–µ–Ω—è—é—Ç –ø–µ—Ä–∏–æ–¥ –∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç –¥–∞–Ω–Ω—ã–µ
- `selectQuickRange()` ~line 2521 - –∞–≤—Ç–æ–≤—ã–∑–æ–≤ `applyDateRange()`
- –ö–æ–Ω–µ—á–Ω–∞—è –¥–∞—Ç–∞ = —Å–µ–≥–æ–¥–Ω—è, —á—Ç–æ–±—ã –≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–æ–≥–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥

**STATUS**: ‚úÖ –°–∏—Å—Ç–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—Ç–∞–µ—Ç! 
- –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –æ—Ç—á–µ—Ç —Ç–æ—á–Ω–∞—è –∫–æ–ø–∏—è WB —Å–∞–π—Ç–∞ (71 –∫–æ–ª–æ–Ω–∫–∞)
- –í–°–Ø –∏—Å—Ç–æ—Ä–∏—è WB –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –¥–ª—è –≤—Å–µ—Ö –º–∞–≥–∞–∑–∏–Ω–æ–≤
- –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –º–∞–≥–∞–∑–∏–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è –≤—Å—è –∏—Å—Ç–æ—Ä–∏—è (–Ω–µ —Ç–æ–ª—å–∫–æ 90 –¥–Ω–µ–π)
- –ê–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤ 3:30 —É—Ç—Ä–∞ (–ë–∏—à–∫–µ–∫) –∫–∞–∂–¥—ã–π –¥–µ–Ω—å
- –í—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã –ø–µ—Ä–∏–æ–¥–∞ —Ä–∞–±–æ—Ç–∞—é—Ç –∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ localStorage

---

## Previous Session (Jan 17, 2026) - ‚úÖ DATABASE VALIDATION & LOCALSTORAGE:

**üéØ CURRENT FOCUS**: –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–ª–æ–Ω–æ–∫ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ –æ—Ç—á—ë—Ç–∞ + –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏ –≤—ã–±–æ—Ä–∞ –º–∞–≥–∞–∑–∏–Ω–∞

### –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ:

**1. COLUMN VALIDATION (Financial Reports)**:
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Å—Ö–µ–º—ã –ë–î (supabase-schema.sql) —Å –¥–∞–Ω–Ω—ã–º–∏ WB API
- **–†–µ–∑—É–ª—å—Ç–∞—Ç**: –°—Ö–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç! 65 –∫–æ–ª–æ–Ω–æ–∫ –¥–∞–Ω–Ω—ã—Ö –≤ wb_financial_reports
- –£–¥–∞–ª–µ–Ω—ã 14 –ª–∏—à–Ω–∏—Ö –∫–æ–ª–æ–Ω–æ–∫ –∏–∑ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã:
  - dlv_prc, fix_tariff_date_from, fix_tariff_date_to
  - acquiring_percent, payment_processing, srv_dbs
  - assembly_id, is_legal_entity, trbx_id
  - installment_cofinancing_amount, wibes_wb_discount_percent
  - cashback_amount, cashback_discount, cashback_commission_change
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∞—è –∫–æ–ª–æ–Ω–∫–∞ `rid` –≤ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
- –û–±–Ω–æ–≤–ª—ë–Ω –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ supabase-schema.sql: "65 –∫–æ–ª–æ–Ω–æ–∫ –¥–∞–Ω–Ω—ã—Ö + 3 —Å–∏—Å—Ç–µ–º–Ω—ã—Ö" (–±—ã–ª–æ "82 –∫–æ–ª–æ–Ω–∫–∏")
- **–¢–µ–ø–µ—Ä—å**: –¢–∞–±–ª–∏—Ü–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ä–æ–≤–Ω–æ 69 –∫–æ–ª–æ–Ω–æ–∫ (—Ç–æ—á–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å –ë–î)

**2. LOCALSTORAGE FOR SELECTED BUSINESS**:
- –ü—Ä–∏ –≤—ã–±–æ—Ä–µ –º–∞–≥–∞–∑–∏–Ω–∞ –∏–∑ dropdown ‚Üí —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ `localStorage.setItem('selectedBusinessId', id)`
- –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ‚Üí –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ `localStorage.getItem('selectedBusinessId')`
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ –º–∞–≥–∞–∑–∏–Ω–∞
- **–§—É–Ω–∫—Ü–∏–∏ –∏–∑–º–µ–Ω–µ–Ω—ã**:
  - `loadBusinesses()` ‚Äî –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π –º–∞–≥–∞–∑–∏–Ω –ø–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º updateBusinessSelector()
  - `switchBusiness()` ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã–π –º–∞–≥–∞–∑–∏–Ω –≤ localStorage
- **–†–µ–∑—É–ª—å—Ç–∞—Ç**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Ç–µ—Ä—è–µ—Ç –≤—ã–±–æ—Ä –º–∞–≥–∞–∑–∏–Ω–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã

**3. CODE CHANGES**:
- index.js ~line 1800: loadBusinesses() –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç selectedBusinessId –∏–∑ localStorage
- index.js ~line 1989: switchBusiness() —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤—ã–±–æ—Ä –≤ localStorage
- index.js ~line 3280: —É–¥–∞–ª–µ–Ω—ã –ª–∏—à–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏ –∏–∑ renderFinReportData()
- supabase-schema.sql line 115: –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π "65 –∫–æ–ª–æ–Ω–æ–∫ –¥–∞–Ω–Ω—ã—Ö"

**STATUS**: ‚úÖ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω, –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã, localStorage —Ä–∞–±–æ—Ç–∞–µ—Ç

---

## Previous Session (Jan 14, 2026) - ‚úÖ SUPABASE MIGRATION COMPLETE:

**üéØ MAJOR ACHIEVEMENT**: –ü–æ–ª–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ Supabase PostgreSQL —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π –¥–∞–Ω–Ω—ã—Ö WB

### –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ:

**1. MIGRATION TO SUPABASE**:
- –°–æ–∑–¥–∞–Ω–∞ —Å—Ö–µ–º–∞ –∏–∑ 7 —Ç–∞–±–ª–∏—Ü –≤ Supabase PostgreSQL (supabase-schema.sql)
- –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–ø–∏—Å–∞–Ω database.js: –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ async/await –≤–º–µ—Å—Ç–æ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö SQLite
- –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏: @supabase/supabase-js, node-cron, dotenv
- –ù–∞—Å—Ç—Ä–æ–µ–Ω .env —Å Supabase URL –∏ Service Role Key
- –°–æ–∑–¥–∞–Ω supabase-client.js –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

**2. AUTO-SYNC SYSTEM (sync-service.js)**:
- Cron job: –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 3:30 AM (–ú–°–ö) –∑–∞–ø—É—Å–∫–∞–µ—Ç `syncAllBusinesses()`
- –§—É–Ω–∫—Ü–∏–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:
  - `syncSales(businessId, wbApiKey)` ‚Äî –∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–¥–∞–∂ –∑–∞ 90 –¥–Ω–µ–π
  - `syncOrders(businessId, wbApiKey)` ‚Äî –∑–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤ –∑–∞ 90 –¥–Ω–µ–π
  - `syncFinancialReport(businessId, wbApiKey)` ‚Äî –∑–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª–Ω–æ–≥–æ —Ñ–∏–Ω. –æ—Ç—á—ë—Ç–∞ (82 –∫–æ–ª–æ–Ω–∫–∏)
  - `syncAllData(businessId, wbApiKey)` ‚Äî –∑–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç—Ä—ë—Ö —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–π
  - `syncAllBusinesses()` ‚Äî —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–∞–≥–∞–∑–∏–Ω–æ–≤
- Batch insert –ø–æ 500 –∑–∞–ø–∏—Å–µ–π –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ sync_logs (—Å—Ç–∞—Ç—É—Å, –∫–æ–ª-–≤–æ –∑–∞–ø–∏—Å–µ–π, –æ—à–∏–±–∫–∏, –≤—Ä–µ–º—è)

**3. NEW STORE AUTO-SYNC**:
- –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –º–∞–≥–∞–∑–∏–Ω–∞ —á–µ—Ä–µ–∑ POST `/api/businesses`:
  - –ú–∞–≥–∞–∑–∏–Ω —Å–æ–∑–¥–∞—ë—Ç—Å—è –≤ Supabase
  - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è `syncService.syncAllData()` –≤ —Ñ–æ–Ω–µ
  - –ù–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
  - –î–∞–Ω–Ω—ã–µ –∑–∞ 90 –¥–Ω–µ–π –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ
  - –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω—ã –≤–æ –≤—Å–µ—Ö –æ—Ç—á—ë—Ç–∞—Ö

**4. API ENDPOINTS REFACTORED**:
- `/api/wb-finance` ‚Üí —Ç–µ–ø–µ—Ä—å —á–∏—Ç–∞–µ—Ç –∏–∑ `db.getSalesFromCache(business_id, dateFrom, dateTo)`
- `/api/wb-sales` ‚Üí —á–∏—Ç–∞–µ—Ç –∏–∑ Supabase wb_sales (—Ñ–∏–ª—å—Ç—Ä –ø–æ sale_id)
- `/api/wb-orders` ‚Üí —á–∏—Ç–∞–µ—Ç –∏–∑ Supabase wb_orders
- `/api/wb-fin-report` ‚Üí —á–∏—Ç–∞–µ—Ç –∏–∑ Supabase wb_financial_reports
- –í—Å–µ endpoint'—ã —Ç–µ–ø–µ—Ä—å **–ù–ï –æ–±—Ä–∞—â–∞—é—Ç—Å—è –∫ WB API –Ω–∞–ø—Ä—è–º—É—é**
- –ë—ã—Å—Ç—Ä—ã–µ –∑–∞–ø—Ä–æ—Å—ã, –Ω–µ—Ç –ª–∏–º–∏—Ç–æ–≤, —Ä–∞–±–æ—Ç–∞ —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏

**5. MANUAL SYNC**:
- –î–æ–±–∞–≤–ª–µ–Ω—ã endpoints:
  - POST `/api/sync/:businessId` ‚Äî —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
  - GET `/api/sync-status/:businessId` ‚Äî —Å—Ç–∞—Ç—É—Å –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- –ö–Ω–æ–ø–∫–∞ "üîÑ –†—É—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ" –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
- –ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∑–∞ 90 –¥–Ω–µ–π, **–∏—Å–∫–ª—é—á–∞—è —Å–µ–≥–æ–¥–Ω—è**

**6. BUGS FIXED**:
- Boolean comparison: `is_active === true || is_active === 1` –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ PostgreSQL/SQLite
- getBusinessById/getDefaultBusiness: –¥–æ–±–∞–≤–ª–µ–Ω await (—Ç–µ–ø–µ—Ä—å async)
- database.js: –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Å Supabase async (getSalesFromCache, getOrdersFromCache, getFinancialReportFromCache)

**7. FILES STRUCTURE**:
```
.env ‚Äî Supabase credentials
supabase-client.js ‚Äî –∫–ª–∏–µ–Ω—Ç Supabase
sync-service.js ‚Äî —Å–µ—Ä–≤–∏—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ (432 —Å—Ç—Ä–æ–∫–∏)
supabase-schema.sql ‚Äî SQL —Å—Ö–µ–º–∞ (7 —Ç–∞–±–ª–∏—Ü)
database.js ‚Äî –ø–æ–ª–Ω–æ—Å—Ç—å—é async (524 —Å—Ç—Ä–æ–∫–∏)
index.js ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω—ã –≤—Å–µ endpoints (4153 —Å—Ç—Ä–æ–∫–∏)
```

**NEXT STEPS** (–µ—Å–ª–∏ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è):
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª–Ω–æ–≥–æ —Ü–∏–∫–ª–∞: —Å–æ–∑–¥–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞ ‚Üí –∞–≤—Ç–æ-—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è ‚Üí –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
- –ü—Ä–æ–≤–µ—Ä–∫–∞ cron job'–∞ (–º–æ–∂–Ω–æ –ø–æ–¥–æ–∂–¥–∞—Ç—å –¥–æ 3:30 –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å –≤—Ä–µ–º—è –¥–ª—è —Ç–µ—Å—Ç–∞)
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ sync_logs

---

## Previous Session (Jan 13, 2026) - ‚úÖ ROUTING RESTRUCTURE:
- **Major Change**: –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –æ—Ç—á–µ—Ç —Ç–µ–ø–µ—Ä—å –≥–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–µ—Ä–≤–∏—Å–∞
- **New Main Page**: `/` - —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –æ—Ç—á–µ—Ç —Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º –∫–æ–º–ø–∞–Ω–∏—è–º–∏ (—Ä–∞–Ω–µ–µ –±—ã–ª `/fin-report`)
- **Products Page**: `/products` - –∞–Ω–∞–ª–∏–∑ —Ç–æ–≤–∞—Ä–æ–≤ MAX UI (—Ä–∞–Ω–µ–µ –±—ã–ª `/`)
- **Navigation Updated**: 
  - –ù–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ (`/`) –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ "üîç –ê–Ω–∞–ª–∏–∑ —Ç–æ–≤–∞—Ä–æ–≤" ‚Üí `/products`
  - –ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ `/products` –∫–Ω–æ–ø–∫–∞ "üìà –§–∏–Ω –æ—Ç—á—ë—Ç" –∑–∞–º–µ–Ω–µ–Ω–∞ –Ω–∞ "üîç –ì–ª–∞–≤–Ω–∞—è" ‚Üí `/`
- **Login Redirect**: –ü–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ `/` (—Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –æ—Ç—á–µ—Ç)
- **Code Changes**:
  - `app.get('/')` —Ç–µ–ø–µ—Ä—å –æ–±—Å–ª—É–∂–∏–≤–∞–µ—Ç —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –æ—Ç—á–µ—Ç (index.js ~line 1340)
  - `app.get('/products')` –æ–±—Å–ª—É–∂–∏–≤–∞–µ—Ç MAX UI –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ç–æ–≤–∞—Ä–æ–≤ (index.js ~line 758)
  - –£–¥–∞–ª—ë–Ω —Å—Ç–∞—Ä—ã–π –º–∞—Ä—à—Ä—É—Ç `/fin-report`
- **Reason**: –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –æ—Ç—á–µ—Ç ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –ª–æ–≥–∏—á–Ω–æ —Å–¥–µ–ª–∞—Ç—å –µ–≥–æ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ–π
- **Status**: ‚úÖ Server restarted, changes applied

Previous Session (Dec 23, 2025):
- **Issue Found**: Companies dropdown on `/fin-report` shows "–ó–∞–≥—Ä—É–∑–∫–∞..." but doesn't populate
- **Root Cause**: `loadBusinesses()` function was defined but only called from `openBusinessManager()` modal, not on page initialization
- **Fix Applied**: Added `DOMContentLoaded` event listener before closing `</script>` tag to auto-call `loadBusinesses()` when page loads
- **Code Location**: index.js lines 2955-2962 (closing `/fin-report` route template)
- **Status**: ‚úÖ Server restarted successfully - fix applied and ready for testing
- **Next Action**: Verify companies now load automatically in dropdown selector on page load

Last Session Completed (Dec 17, 2025 - Evening):
- ‚úÖ New UI/UX workflow for financial reports (modal-based approach)
- ‚úÖ Loading indicators with visual feedback (spinner + badges)
- ‚úÖ Click outside modal to close functionality
- ‚úÖ Data validation before opening reports
- ‚úÖ Error handling improvements for async loading
- ‚úÖ Button "–û–ë–ù–û–í–ò–¢–¨ –î–ê–ù–ù–´–ï" moved to top-right corner
- ‚úÖ All report buttons converted to modal triggers with unique colors

Previous Session (Dec 17, 2025 - Afternoon):
- ‚úÖ Multi-company aggregation for sales report ("–í—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏" mode)
- ‚úÖ Company name column added to sales report (first column)
- ‚úÖ Sortable columns with visual indicators (‚Üï symbol, hover effects)
- ‚úÖ Default sort by company name (alphabetically)
- ‚úÖ Tabs system for financial report when multiple companies loaded
- ‚úÖ Tab switching using numeric indices (avoids quote escaping issues)
- ‚úÖ Default selector set to "All active companies" when multiple exist
- ‚úÖ Improved tab design: flat style, color-coded, underline indicator

Current Focus:
- Modal-based report viewing system fully operational
- Loading state management with visual indicators
- Better UX for data fetching and error handling
- All 3 reports load in parallel when "–û–ë–ù–û–í–ò–¢–¨ –î–ê–ù–ù–´–ï" clicked

Recent Changes (Dec 17, 2025 - Evening):

**‚úÖ COMPLETED - MODAL WORKFLOW & LOADING INDICATORS:**
- **NEW WORKFLOW**:
  - **"–û–ë–ù–û–í–ò–¢–¨ –î–ê–ù–ù–´–ï" button**: Single button loads all 3 reports at once (parallel loading)
  - **Report buttons**: Now open modals instead of switching views (üìà –§–∏–Ω –æ—Ç—á—ë—Ç, üí∞ –ü—Ä–æ–¥–∞–∂–∏, üì¶ –ó–∞–∫–∞–∑—ã)
  - **Button positioning**: "–û–ë–ù–û–í–ò–¢–¨ –î–ê–ù–ù–´–ï" moved to top-right corner with purple style matching other nav buttons
  - **Color-coded buttons**: Each report button has unique gradient (purple, pink, cyan)
- **LOADING INDICATORS**:
  - **Main loading block**: Shows below buttons with animated spinner during data fetch
  - **Badge indicators**: Small ‚è≥ badges appear on each report button while loading
  - **Progressive completion**: Each badge disappears when its report finishes loading
  - **Auto-hide**: Main loading block hides when all 3 reports complete
  - **CSS animations**: `@keyframes spin` for spinner, `@keyframes pulse` for badges
- **DATA VALIDATION**:
  - **Global flags**: `finReportDataLoaded`, `salesReportDataLoaded`, `ordersDataLoaded`
  - **Empty state message**: "–î–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã" (simplified, gray text) when opening unloaded report
  - **Flag reset**: All flags reset to `false` when "–û–ë–ù–û–í–ò–¢–¨ –î–ê–ù–ù–´–ï" clicked
  - **Error handling**: Flags set to `true` even on errors/empty data to prevent infinite loading
- **MODAL IMPROVEMENTS**:
  - **Click outside to close**: Click on modal backdrop closes the modal (using `onclick` with `event.stopPropagation()`)
  - **Modal structure**: Each modal has `onclick` handler, inner content has `stopPropagation()`
  - **Function**: `closeModalOnOutsideClick(event, modalId)` checks if click target is backdrop
- **ERROR HANDLING**:
  - **All fetch operations**: Set loading flags even on error/catch blocks
  - **Empty data**: Set loading flags when `data.items` is empty or null
  - **Prevents infinite wait**: Ensures loading indicators always complete
- **CODE LOCATIONS** (index.js):
  - Lines 1355-1385: Main loading indicator HTML + button badges
  - Lines 1598-1602: Global loading flags declaration
  - Lines 2192-2212: `loadFinancialData()` - resets flags, shows indicators, loads all reports
  - Lines 2214-2223: `checkAllDataLoaded()` - hides indicators when all complete
  - Lines 2225-2255: Modal open functions with data validation
  - Lines 2290-2335: `loadOrders()` with error flag handling
  - Lines 2421-2460: `loadSalesReport()` with error flag handling
  - Lines 2655-2707: `loadFullFinReport()` with error flag handling
  - CSS animations: `@keyframes spin` and `@keyframes pulse` for visual effects

Recent Changes (Dec 17, 2025 - Afternoon):
  - **Console logging**: Added debugging logs for data flow tracking (to be removed later)
  - **Error prevention**: Removed getElementById('datasetBody') causing null reference errors
- **CODE LOCATIONS** (index.js):
  - Lines 2372-2540: `displaySalesReport()` - renders sales with company column, sorting, aggregation
  - Lines 2480-2547: `sortSalesReport()` - handles column sorting with state management
  - Lines 2549-2590: `loadFullFinReport()` - loads financial data, supports 'all' mode
  - Lines 2607-2682: `displayFullFinReport()`, `switchFinReportCompany()`, `highlightActiveFinTab()` - tab system
  - Lines 2684-2750: `renderFinReportData()` - renders financial report table
  - Lines 1803-1848: `updateBusinessSelector()` - defaults to 'all' when multiple companies

Recent Changes (Dec 7, 2025 - Late Evening):

**‚úÖ COMPLETED - PRODUCT COST MANAGEMENT (–°–ï–ë–ï–°–¢–û–ò–ú–û–°–¢–¨):**
- **NEW BUTTON**: "üí∞ –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å" button added after "üì¶ –ó–∞–∫–∞–∑—ã" button
- **NEW MODAL**: Dedicated modal for product cost management
- **NEW DB TABLE**: `product_costs` (business_id, nm_id, subject, brand, cost)
- **CASCADE DELETE**: Removing business deletes all its product costs
- **DATABASE FUNCTIONS**:
  - `upsertProductCost()` - save/update single product cost
  - `bulkUpsertProductCosts()` - batch save multiple costs
  - `getProductCostsByBusiness()` - load all costs for a business
  - `getProductCost()` - get cost for specific product
  - `deleteProductCost()` - remove product cost
- **API ENDPOINTS**:
  - GET `/api/product-costs/:businessId` - list all costs
  - POST `/api/product-costs/:businessId/bulk` - bulk save costs
  - GET `/api/product-costs/:businessId/:nmId` - get single cost
  - DELETE `/api/product-costs/:businessId/:nmId` - delete cost
- **UI FEATURES**:
  - Modal with fixed size (max-width: 1000px, max-height: 80vh)
  - Internal scrolling for large datasets
  - "üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É" button to fetch products from WB API
  - Products auto-load from sales data (via `/api/wb-sales-grouped`)
  - "üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å" button to persist costs to database
  - 4 columns: –ê—Ä—Ç–∏–∫—É–ª WB, –ü—Ä–µ–¥–º–µ—Ç, –ë—Ä–µ–Ω–¥, –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å (‚ÇΩ)
  - Manual cost input per product (number input field)
  - Auto-load saved costs when opening modal
  - Costs persist across sessions per business
- **DATA FLOW**:
  - Modal uses parent's `currentBusinessId` for API calls
  - No API key stored in modal itself
  - Fetches product list via sales endpoint
  - Merges saved costs from DB with fresh product data
  - Each business has independent cost tracking

**‚úÖ COMPLETED - DATABASE & MULTI-COMPANY ARCHITECTURE:**
- **DATABASE**: SQLite with `better-sqlite3` package
- **TABLES**: 
  - `accounts` (id, username, password_hash, email, timestamps)
  - `businesses` (id, account_id, company_name, wb_api_key, description, is_active, timestamps)
- **RELATIONS**: CASCADE DELETE on account removal (deletes all businesses)
- **SECURITY**: Password hashing with SHA256 + salt (pbkdf2)
- **MIGRATION**: Auto-migration from `wb-api-key.txt` to database on first run
- **DEFAULT ACCOUNT**: Created automatically: admin / tarelkastakan

**‚úÖ COMPLETED - AUTHENTICATION SYSTEM:**
- **OLD SYSTEM REMOVED**: Static ADMIN_LOGIN/ADMIN_PASSWORD constants deleted
- **NEW SYSTEM**: Database-driven authentication via `database.js` module
- **LOGIN**: POST `/api/login` returns account ID as token (stored in httpOnly cookie)
- **MIDDLEWARE**: `requireAuth` checks cookie token and loads account from DB
- **SESSION**: Account object attached to `req.account` on each request

**‚úÖ COMPLETED - BUSINESS MANAGEMENT UI:**
- **OLD MODAL REMOVED**: "–î–æ–±–∞–≤–∏—Ç—å API –∫–ª—é—á" button and modal deleted
- **NEW UI**: "üè¢ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏—è–º–∏" button opens business manager modal
- **FEATURES**:
  - List all companies with status badges (active/inactive)
  - Add new company with form (name, API key, description)
  - Toggle active/inactive status per company
  - Delete company with confirmation
  - Company selector dropdown in header
  - Auto-load first active company on page load

**‚úÖ COMPLETED - FINANCIAL REPORTS WITH MULTI-COMPANY:**
- **PAGE**: `/fin-report` - financial dashboard per selected company
- **API ENDPOINTS UPDATED**:
  - `/api/wb-finance?businessId=X` - financial data for specific company
  - `/api/wb-sales?businessId=X` - sales for specific company
  - `/api/wb-orders?businessId=X` - orders for specific company
  - `/api/wb-sales-grouped?businessId=X` - grouped sales
  - `/api/wb-fin-report?businessId=X` - full WB financial report (82 columns)
- **BUSINESS APIS**:
  - GET `/api/businesses` - list all companies of current account
  - POST `/api/businesses` - create new company
  - PUT `/api/businesses/:id` - update company (name, key, status)
  - DELETE `/api/businesses/:id` - delete company
  - GET `/api/businesses/default` - get first active company
- **REPORT TYPES**: 
  - üìà Financial Report (82 columns - full WB report structure)
  - üí∞ Sales Report (10 columns - grouped by unique articles)
- **UI FEATURES**:
  - Company selector with auto-switch
  - Business manager modal with CRUD operations
  - All load functions check `currentBusinessId` before API calls
  - Date range selector (custom periods)
  - Toggle buttons for report types
  - 5 dashboard cards (revenue, commission, logistics, profits)
  - Dynamic table headers (82 vs 10 columns)
  - Sticky header on scroll

Recent Changes (Dec 2, 2025):

**LATEST UPDATE - AUTH FIX FOR VERCEL:**
- **CRITICAL FIX**: –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ httpOnly cookies (—Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ serverless)
- **PACKAGE**: –î–æ–±–∞–≤–ª–µ–Ω `cookie-parser` –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å cookies
- **LOGIN FLOW**: POST /api/login —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç cookie —Å base64 —Ç–æ–∫–µ–Ω–æ–º
- **MIDDLEWARE**: requireAuth –ø—Ä–æ–≤–µ—Ä—è–µ—Ç cookie (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç) –∏ Authorization header (fallback)
- **SECURITY**: httpOnly=true, secure –≤ production, sameSite=lax, maxAge=24h
- **TESTED LOCALLY**: ‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º
- **RESULT**: –°—Ç–∞–±–∏–ª—å–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –Ω–∞ Vercel –±–µ–∑ –ø—Ä–æ–±–ª–µ–º —Å —Å–µ—Å—Å–∏—è–º–∏

**UPDATE - CATEGORY PARSING FROM API:**
- **CRITICAL CHANGE**: –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–µ–ø–µ—Ä—å –ø–∞—Ä—Å—è—Ç—Å—è –∏–∑ –ø–æ–ª—è `product.entity` (API v2)
- **DATA SOURCE**: –ü–æ–ª–µ `entity` —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
- **REMOVED**: –£–¥–∞–ª—ë–Ω —Å—Ç–∞—Ç–∏—á–Ω—ã–π –º–∞–ø–ø–∏–Ω–≥ `subjectId ‚Üí –Ω–∞–∑–≤–∞–Ω–∏–µ` (40+ —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞)
- **EXAMPLES**: "–∫—Ä–æ—Å—Å–æ–≤–∫–∏" ‚Üí "–ö—Ä–æ—Å—Å–æ–≤–∫–∏", "—é–±–∫–∏" ‚Üí "–Æ–±–∫–∏", "–∑–æ–Ω—Ç—ã –ø–ª—è–∂–Ω—ã–µ" ‚Üí "–ó–æ–Ω—Ç—ã –ø–ª—è–∂–Ω—ã–µ"
- **FORMATTING**: –ü–µ—Ä–≤–∞—è –±—É–∫–≤–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∑–∞–≥–ª–∞–≤–Ω–æ–π –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã
- **BENEFIT**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ –í–°–ï–• –∫–∞—Ç–µ–≥–æ—Ä–∏–π WB –±–µ–∑ —Ä—É—á–Ω–æ–≥–æ –º–∞–ø–ø–∏–Ω–≥–∞
- **PERFORMANCE**: –ù—É–ª–µ–≤—ã–µ –Ω–∞–∫–ª–∞–¥–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã, –¥–∞–Ω–Ω—ã–µ —É–∂–µ –≤ API
- **CSV**: –û–±–Ω–æ–≤–ª–µ–Ω—ã –æ–±–∞ endpoint (/wb-max –∏ /wb-max-csv)

**LATEST UPDATE - SIMPLIFIED SELLER DATA:**
- **DECISION**: –û—Ç–∫–ª—é—á–µ–Ω –ø–∞—Ä—Å–∏–Ω–≥ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏—Ö –ª–∏—Ü (WB –±–ª–æ–∫–∏—Ä—É–µ—Ç –≤—Å–µ –º–µ—Ç–æ–¥—ã)
- **CURRENT STATE**: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ sellerId + storeName (—Ç–æ—Ä–≥–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–∑ API)
- **TWO COLUMNS**: 
  1. `–ü—Ä–æ–¥–∞–≤–µ—Ü (ID)` - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ ID –ø—Ä–æ–¥–∞–≤—Ü–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä "ID: 1399211")
  2. `–ú–∞–≥–∞–∑–∏–Ω` - —Ç–æ—Ä–≥–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–∑ `product.supplier` (–Ω–∞–ø—Ä–∏–º–µ—Ä "–ú–∞—Ä–∏—è–º")
- **REASON**: Wildberries –±–ª–æ–∫–∏—Ä—É–µ—Ç –ø–∞—Ä—Å–∏–Ω–≥ (–∫–æ–¥ 498, –∫–∞–ø—á–∞, –∞–Ω—Ç–∏-–±–æ—Ç –∑–∞—â–∏—Ç–∞)
- **FUTURE**: –î–ª—è –ø–æ–ª–Ω—ã—Ö —é—Ä–ª–∏—Ü —Ç—Ä–µ–±—É–µ—Ç—Å—è Puppeteer/Selenium –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω–æ–º VPS
- **ARCHITECTURE**: –ù–µ—Ç —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–π –±–∞–∑—ã –ø—Ä–æ–¥–∞–≤—Ü–æ–≤ - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ API –¥–∞–Ω–Ω—ã–µ
- **PERFORMANCE**: –ë—ã—Å—Ç—Ä–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ ~1-3 —Å–µ–∫ –±–µ–∑ –ø–æ–ø—ã—Ç–æ–∫ –ø–∞—Ä—Å–∏–Ω–≥–∞

Previous Changes:
- **NEW FEATURE**: –î–æ–±–∞–≤–ª–µ–Ω—ã –∫–æ–ª–æ–Ω–∫–∏ "–ö–∞—Ç–µ–≥–æ—Ä–∏—è" –∏ "–¶–≤–µ—Ç" –º–µ–∂–¥—É –ü—Ä–æ–¥–∞–≤—Ü–æ–º –∏ –¶–µ–Ω–æ–π
- **DATA SOURCE**: –ö–∞—Ç–µ–≥–æ—Ä–∏—è –∏–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è –∏–∑ `product.subjectId` —Å –º–∞–ø–ø–∏–Ω–≥–æ–º –Ω–∞ –Ω–∞–∑–≤–∞–Ω–∏—è (40+ –∫–∞—Ç–µ–≥–æ—Ä–∏–π)
- **DATA SOURCE**: –¶–≤–µ—Ç –∏–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è –∏–∑ `product.colors[0].name` (–±–µ—Ä–µ–º –ü–ï–†–í–´–ô —Ü–≤–µ—Ç - –æ—Å–Ω–æ–≤–Ω–æ–π –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ –∞—Ä—Ç–∏–∫—É–ª–∞)
- **FIX**: –¶–≤–µ—Ç —Ç–µ–ø–µ—Ä—å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ü–≤–µ—Ç —Ç–æ–≤–∞—Ä–∞, –∞ –Ω–µ –≤—Å–µ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é
- **MAPPING**: –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –º–∞–ø–ø–∏–Ω–≥ –∫–∞—Ç–µ–≥–æ—Ä–∏–π: –æ–¥–µ–∂–¥–∞, –æ–±—É–≤—å, —ç–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞, –¥–æ–º, –∫—Ä–∞—Å–æ—Ç–∞, –¥–µ—Ç—è–º, –∞–≤—Ç–æ
- **MAJOR CHANGE**: –£–±—Ä–∞–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ –ò–ü - —Ç–µ–ø–µ—Ä—å –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –í–°–ï–• –ø—Ä–æ–¥–∞–≤—Ü–æ–≤
- **UI CHANGE**: –ö–æ–ª–æ–Ω–∫–∞ "–ü—Ä–æ–¥–∞–≤–µ—Ü (ID)" –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç: `–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥–∞–≤—Ü–∞ (ID –ø—Ä–æ–¥–∞–≤—Ü–∞)`
- **SIMPLIFICATION**: –£–±—Ä–∞–Ω–æ –ø–æ–ª–µ `sellerName` - —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ `storeName` –∏–∑ `product.supplier`
- **SIMPLIFICATION**: –£–¥–∞–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ò–ü –ø–µ—Ä–µ–¥ –ø–∞—Ä—Å–∏–Ω–≥–æ–º - –±–µ—Ä—ë–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–∑ API –¥–ª—è –≤—Å–µ—Ö
- **REMOVED**: –£–¥–∞–ª–µ–Ω–∞ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∞—è –±–∞–∑–∞ –ø—Ä–æ–¥–∞–≤—Ü–æ–≤ (sellers-db.json) - –Ω–µ –Ω—É–∂–Ω–∞
- **CSV UPDATE**: –û–±–Ω–æ–≤–ª—ë–Ω —Ñ–æ—Ä–º–∞—Ç CSV - –¥–æ–±–∞–≤–ª–µ–Ω—ã `category` –∏ `color`, —É–±—Ä–∞–Ω–∞ `sellerName`
- **CRITICAL FIX**: –£–¥–∞–ª—ë–Ω –º–µ–¥–ª–µ–Ω–Ω—ã–π `fetchStoreNameFromProductPage` –∫–æ—Ç–æ—Ä—ã–π –¥–µ–ª–∞–ª 3+ HTTP-–∑–∞–ø—Ä–æ—Å–∞
- **CRITICAL FIX**: –£–ø—Ä–æ—â—ë–Ω `extractPrice` - —É–±—Ä–∞–Ω—ã –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∏, –æ—Å—Ç–∞–≤–ª–µ–Ω—ã —Ç–æ–ª—å–∫–æ —Ä–∞–±–æ—á–∏–µ –ø–æ–ª—è
- **CRITICAL FIX**: –£–¥–∞–ª–µ–Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ `summarizeStocks` (–±—ã–ª–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –¥–≤–∞–∂–¥—ã)
- **CRITICAL FIX**: –î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ `safeGet` –∏ `currencyByDomain` –≤ wb-max-csv
- **UI FIX**: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–Ω—ã - —Ç–µ–ø–µ—Ä—å `price !== null && price > 0` –≤–º–µ—Å—Ç–æ `typeof price === 'number'`
- **UI FIX**: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –∏–Ω–¥–µ–∫—Å—ã innerHTML - –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è —Ñ–æ—Ç–æ, —Å–∫–ª–∞–¥—ã –∏ —Å—Ç–∞—Ç—É—Å
- **UI FIX**: –¢–æ–≤–∞—Ä—ã –±–µ–∑ –æ—Å—Ç–∞—Ç–∫–æ–≤ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç "–Ω–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏" –≤–º–µ—Å—Ç–æ "0.00"
- **CRITICAL FIX**: –ù–∞–∑–≤–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞ –±–µ—Ä—ë—Ç—Å—è –∏–∑ `product.supplier` –≤ API v2 (–Ω–µ —Ç—Ä–µ–±—É–µ—Ç –ø–∞—Ä—Å–∏–Ω–≥–∞!)
- –†–µ–∑—É–ª—å—Ç–∞—Ç: –∑–∞–≥—Ä—É–∑–∫–∞ **~2-8 —Å–µ–∫** (—Å —É—á–µ—Ç–æ–º –ø–∞—Ä—Å–∏–Ω–≥–∞), –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–Ω—ã–µ —é—Ä–ª–∏—Ü–∞ –∏–ª–∏ –∫—Ä–∞—Ç–∫–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è
- UI: –∞—Ä—Ç–∏–∫—É–ª ‚Äî —Å—Å—ã–ª–∫–∞ –Ω–∞ KG
- UI: –∫–æ–ª–æ–Ω–∫–∞ `–°–∫–ª–∞–¥—ã` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç `–ù–∞–∑–≤–∞–Ω–∏–µ ‚Äî N —à—Ç`, –º–æ–¥–µ–ª—å FBO/FBS

Next Steps:
- –î–æ–±–∞–≤–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∞—Å—Ç–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- –†–∞—Å—à–∏—Ä—è—Ç—å —Å–ª–æ–≤–∞—Ä—å `wh ‚Üí –Ω–∞–∑–≤–∞–Ω–∏–µ` –ø–æ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è–º

Decisions:
- –°–æ—Ö—Ä–∞–Ω—è—Ç—å `/wb-price-csv` –ø—É–±–ª–∏—á–Ω—ã–º –∏ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º.
- HTML –ø–∞—Ä—Å–∏–Ω–≥ –∏–º–µ–Ω–∏ –ø—Ä–æ–¥–∞–≤—Ü–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –¥–ª—è JSON/UI, –Ω–µ —É—Ç—è–∂–µ–ª—è—è CSV.
- –í UI –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –ø—Ä–æ—Å—Ç–æ—Ç—É —á—Ç–µ–Ω–∏—è —á–µ—Ä–µ–∑ —Ä–∞–∑–¥–µ–ª—å–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏.
- –î–∞–Ω–Ω—ã–µ –ø–æ —Å–∫–ª–∞–¥–∞–º —Å—á–∏—Ç–∞—é—Ç—Å—è –∏–∑ –ø—É–±–ª–∏—á–Ω–æ–≥–æ `sizes[].stocks` (–∞–≥—Ä–µ–≥–∞—Ü–∏—è –ø–æ `wh`).
- –î–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –ø—É–±–ª–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ WB (–±–µ–∑ –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö –∫–ª—é—á–µ–π).

Preferences:
- Minimal public endpoints; robust fallbacks; readable UI.

Learnings:
- Wildberries APIs can vary; layered fallbacks are essential.
- Sheets `IMPORTDATA` returns headers+data; use `INDEX` to select cells.
