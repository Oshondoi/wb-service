# Система парсинга юридических лиц продавцов WB

## Обзор

Система теперь **АВТОМАТИЧЕСКИ** пытается получить полное юридическое название продавца для **ЛЮБОГО** артикула на Wildberries.

## Как это работает

### 3-уровневая система получения данных о продавце:

```
1. Статическая база (sellers-db.json)
   ↓ (если не найдено)
2. LIVE парсинг страницы продавца на WB
   ↓ (если заблокировано)
3. Краткое торговое название из API
```

### Детали реализации

#### 1. Статическая база `sellers-db.json`
- Содержит 3 продавца: KOTON (25030), QUATRO (1315377), АНТАРЕС (86974)
- Мгновенный доступ без дополнительных запросов
- Легко расширяется вручную

#### 2. Live парсинг `fetchLegalEntityName(sellerId)`
**Вызывается для КАЖДОГО артикула** который не найден в статической базе:

- Пробует 3 домена: `wildberries.kg`, `wildberries.kz`, `wildberries.ru`
- URL: `https://www.{domain}/seller/{sellerId}`
- Случайная задержка 0.5-2 сек между запросами (anti-bot)
- Реалистичные HTTP-заголовки (Chrome 120, Sec-Fetch-*, Accept-Encoding)
- Timeout: 15 секунд на каждый домен

**Что извлекается:**
- Полные названия ООО: "Общество с ограниченной ответственностью ..."
- Полные названия ИП: "Индивидуальный предприниматель Иванов Иван Иванович"
- Полные названия АО: "Акционерное общество ..."

**Обработка ошибок:**
- Код 498 (анти-бот блокировка) → переход к fallback
- Timeout → пробует следующий домен
- Любая ошибка → сохраняет пустую строку в кэш

#### 3. Fallback: `product.supplier`
- Краткое торговое название из API WB
- Примеры: "BREMENGEN", "KOTON", "QUATRO"
- Всегда доступно если товар найден в API

### Кэширование

**Map-кэш `LEGAL_NAMES_CACHE`:**
- Один продавец парсится только 1 раз за сессию сервера
- Ключ: `sellerId` (строка)
- Значение: полное юридическое название или пустая строка
- Сбрасывается при перезапуске сервера

### Примеры логов

**Успешный парсинг:**
```
✓ Найдено юрлицо для 25030 (wildberries.kg): Общество с ограниченной ответственностью Котон Текстиль
```

**Блокировка WB:**
```
Не удалось загрузить wildberries.ru/seller/1227089: Request failed with status code 498
✗ Не удалось получить юрлицо для продавца 1227089
⚠ Для 1227089 используем краткое название: BREMENGEN
```

**Из кэша:**
```
✓ Из кэша для 1227089: BREMENGEN
```

**Из статической базы:**
```
✓ Из базы для 25030: Общество с ограниченной ответственностью Котон Текстиль
```

## Производительность

- **Без парсинга** (из базы/кэша): ~1-3 сек
- **С парсингом** (первый запрос): ~4-8 сек (0.5-2s задержка × 3 домена)
- **Блокировка WB**: ~3-5 сек (timeout на первом домене, переход к fallback)

## Endpoints

### `/wb-max` (JSON)
Вызывает `fetchLegalEntityName()` если `sellerId` не в `SELLERS_DB`

### `/wb-max-csv` (CSV)
Вызывает `fetchLegalEntityName()` если `sellerId` не в `SELLERS_DB`

### `/wb-price-csv` (CSV, публичный)
НЕ парсит юрлица (минимальный endpoint для Google Sheets)

## Ограничения

1. **WB блокирует парсеры**: Большинство запросов получают код 498
2. **Нужны прокси**: Для массового парсинга потребуются ротирующиеся прокси
3. **Captcha**: Иногда WB показывает капчу вместо страницы продавца
4. **Rate limiting**: Слишком частые запросы → блокировка IP

## Рекомендации

### Для расширения базы продавцов:
1. Вручную добавлять часто запрашиваемых продавцов в `sellers-db.json`
2. Использовать браузерное расширение для автоматического сбора данных
3. Использовать прокси-сервисы (BrightData, Oxylabs) для массового парсинга

### Для улучшения успешности парсинга:
1. Добавить selenium/puppeteer для полноценного рендеринга JS
2. Использовать residential прокси
3. Добавить решатели капчи (2captcha, anti-captcha)
4. Увеличить задержки между запросами

## Код

### Ключевые функции

**`fetchLegalEntityName(sellerId)`** - основная функция парсинга
- Местоположение: `index.js`, строки ~590-660
- Вызывается из: `/wb-max` и `/wb-max-csv`

**Кэш:**
```javascript
const LEGAL_NAMES_CACHE = new Map();
```

**Использование в endpoint:**
```javascript
if (sellerId) {
  if (SELLERS_DB[String(sellerId)]) {
    storeName = SELLERS_DB[String(sellerId)].legalName || storeName;
  } else {
    const legalName = await fetchLegalEntityName(sellerId);
    if (legalName) storeName = legalName;
  }
}
```

## Результат

✅ **Для ЛЮБОГО артикула** система теперь:
1. Пытается получить полное юридическое лицо
2. Использует краткое название при блокировке
3. Кэширует результаты для повторных запросов
4. НЕ падает при ошибках парсинга

**Больше нет "заготовок текста только для 3 артикулов"** - система универсальна!
